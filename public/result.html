<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>客户分类系统 - 结果</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="pdf-content">
        <div class="container">
            <h1>分析结果</h1>
            <div id="result-content">
                <!-- 这里的内容将由 JavaScript 动态生成 -->
            </div>
        </div>
    </div>

    <div class="button-group">
        <button id="download-pdf" class="btn btn-success"><i class="fas fa-file-pdf"></i> 生成 PDF</button>
        <a href="/" class="btn btn-warning"><i class="fas fa-user-plus"></i> 新客户</a>
        <a href="/select_options.html" class="btn btn-primary"><i class="fas fa-edit"></i> 返回修改</a>
    </div>

    <script>
        // 递归渲染树形结构
        function renderTree(tree) {
            if (!tree) return '';
            
            let html = '<ul>';
            for (const [key, value] of Object.entries(tree)) {
                html += `<li>${key}`;
                if (value) {
                    if (Array.isArray(value)) {
                        html += '<ul>';
                        for (const item of value) {
                            html += `<li>${item}</li>`;
                        }
                        html += '</ul>';
                    } else {
                        html += renderTree(value);
                    }
                }
                html += '</li>';
            }
            html += '</ul>';
            return html;
        }

        // 加载结果数据
        async function loadResult() {
            const response = await fetch('/api/get-result');
            const data = await response.json();
            
            const content = document.getElementById('result-content');
            content.innerHTML = `
                <p><strong>客户姓名：</strong>${data.customerName}</p>
                <p><strong>客户观念分型：</strong>${data.customerType}</p>
                <p><strong>客户分析及策略：</strong></p>
                ${renderTree(data.selectedTree)}
            `;
        }

        // PDF 生成功能
        document.getElementById('download-pdf').addEventListener('click', async function () {
            const element = document.getElementById('pdf-content');
            const resultData = await fetch('/api/get-result').then(r => r.json());
            const filename = `${resultData.customerName}_分类结果.pdf`;

            // 创建加载提示
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '正在生成PDF，请稍候...';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '50%';
            loadingDiv.style.left = '50%';
            loadingDiv.style.transform = 'translate(-50%, -50%)';
            loadingDiv.style.padding = '20px';
            loadingDiv.style.background = 'rgba(0,0,0,0.7)';
            loadingDiv.style.color = 'white';
            loadingDiv.style.borderRadius = '5px';
            loadingDiv.style.zIndex = '9999';
            document.body.appendChild(loadingDiv);

            try {
                const { jsPDF } = window.jspdf;

                // 创建临时容器并复制样式
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = element.innerHTML;
                
                // 添加 PDF 专用样式
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    .container > ul > li {
                        color: #007bff !important;
                    }
                    .container > ul > li > ul {
                        color: black !important;
                    }
                    .container ul > li {
                        list-style-type: disc !important;
                    }
                `;
                tempContainer.appendChild(styleElement);
                
                // 复制原始元素的样式
                const styles = window.getComputedStyle(element);
                tempContainer.style.cssText = styles.cssText;
                
                // 复制所有子元素的样式
                const originalElements = element.getElementsByTagName('*');
                const tempElements = tempContainer.getElementsByTagName('*');
                for (let i = 0; i < originalElements.length; i++) {
                    const computedStyle = window.getComputedStyle(originalElements[i]);
                    tempElements[i].style.cssText = computedStyle.cssText;
                }

                // 设置临时容器的基本样式
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '20px';
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.backgroundColor = '#ffffff';
                tempContainer.style.fontFamily = styles.fontFamily;
                document.body.appendChild(tempContainer);

                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800,
                    windowWidth: 800
                });

                // PDF 尺寸计算和生成
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                const margin = 5;
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);

                const imageRatio = canvas.width / canvas.height;
                let imgWidth = contentHeight * imageRatio;
                let imgHeight = contentHeight;

                if (imgWidth > contentWidth) {
                    imgWidth = contentWidth;
                    imgHeight = contentWidth / imageRatio;
                }

                const x = margin + (contentWidth - imgWidth) / 2;
                const y = margin;
                
                pdf.addImage(
                    canvas.toDataURL('image/jpeg', 1.0),
                    'JPEG',
                    x,
                    y,
                    imgWidth,
                    imgHeight,
                    undefined,
                    'FAST'
                );

                pdf.save(filename);
                document.body.removeChild(tempContainer);

            } catch (error) {
                console.error('PDF generation error:', error);
                alert(`生成PDF时发生错误: ${error.message}`);
            } finally {
                document.body.removeChild(loadingDiv);
            }
        });

        // 页面加载时获取数据
        window.addEventListener('load', loadResult);
    </script>
</body>
</html> 