<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>客户分类系统 - 结果</title>
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入 Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- 将需要生成 PDF 的内容包裹在一个 div 中 -->
    <div id="pdf-content">
        <!-- 定义递归宏 -->
        {% macro render_tree(tree) %}
        {% if tree %}
            <ul>
            {% for key, value in tree.items() %}
                <li>
                    {{ key }}
                    {% if value is defined %}
                        {% if value.items is defined %}
                            {{ render_tree(value) }}
                        {% else %}
                            <ul>
                                {% for item in value %}
                                    <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}
                </li>
            {% endfor %}
            </ul>
        {% endif %}
    {% endmacro %}

        <div class="container">
            <h1>分析结果</h1>
            <p><strong>客户姓名：</strong>{{ customer_name }}</p>
            <p><strong>客户观念分型：</strong>{{ customer_type }}</p>
            <p><strong>客户分析及策略：</strong></p>
            {% if selected_tree %}
                {{ render_tree(selected_tree) }}
            {% else %}
                <p>您未选择任何选项。</p>
            {% endif %}
        </div>
    </div>

    <!-- 按钮组 -->
    <div class="button-group">
        <button id="download-pdf" class="btn btn-success"><i class="fas fa-file-pdf"></i> 生成 PDF</button>
        <a href="{{ url_for('new_customer') }}" class="btn btn-warning"><i class="fas fa-user-plus"></i> 新客户</a>
        <a href="{{ url_for('select_options') }}" class="btn btn-primary"><i class="fas fa-edit"></i> 返回修改</a>
    </div>
    

    <!-- 添加生成 PDF 的脚本 -->
    <script>
        document.getElementById('download-pdf').addEventListener('click', async function () {
            const element = document.getElementById('pdf-content');
            const filename = '{{ customer_name }}_分类结果.pdf';

            // 创建加载提示
            const loadingDiv = document.createElement('div');
            loadingDiv.innerHTML = '正在生成PDF，请稍候...';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '50%';
            loadingDiv.style.left = '50%';
            loadingDiv.style.transform = 'translate(-50%, -50%)';
            loadingDiv.style.padding = '20px';
            loadingDiv.style.background = 'rgba(0,0,0,0.7)';
            loadingDiv.style.color = 'white';
            loadingDiv.style.borderRadius = '5px';
            loadingDiv.style.zIndex = '9999';
            document.body.appendChild(loadingDiv);

            try {
                const { jsPDF } = window.jspdf;

                // 创建临时容器并复制样式
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = element.innerHTML;
                
                // 添加 PDF 专用样式
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    .container > ul > li {
                        color: #007bff !important;
                    }
                    .container > ul > li > ul {
                        color: black !important;
                    }
                    .container ul > li {
                        list-style-type: disc !important;
                    }
                `;
                tempContainer.appendChild(styleElement);
                
                // 复制原始元素的样式
                const styles = window.getComputedStyle(element);
                tempContainer.style.cssText = styles.cssText;
                
                // 复制所有子元素的样式
                const originalElements = element.getElementsByTagName('*');
                const tempElements = tempContainer.getElementsByTagName('*');
                for (let i = 0; i < originalElements.length; i++) {
                    const computedStyle = window.getComputedStyle(originalElements[i]);
                    tempElements[i].style.cssText = computedStyle.cssText;
                }

                // 设置临时容器的基本样式
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '20px';
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.backgroundColor = '#ffffff';
                tempContainer.style.fontFamily = styles.fontFamily;
                document.body.appendChild(tempContainer);

                const canvas = await html2canvas(tempContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800,
                    windowWidth: 800
                });

                // 调整 PDF 尺寸计算
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                // 设置最小页面边距
                const margin = 5; // 减小到 5mm 边距
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);

                // 计算图片尺寸以填充可用空间
                const imageRatio = canvas.width / canvas.height;
                const pageRatio = contentWidth / contentHeight;

                let imgWidth, imgHeight;

                // 优先填充高度，确保内容尽可能大
                imgHeight = contentHeight;
                imgWidth = contentHeight * imageRatio;

                // 如果宽度超出了可用空间，则按宽度缩放
                if (imgWidth > contentWidth) {
                    imgWidth = contentWidth;
                    imgHeight = contentWidth / imageRatio;
                }

                // 计算居中位置
                const x = margin + (contentWidth - imgWidth) / 2;
                const y = margin;
                
                pdf.addImage(
                    canvas.toDataURL('image/jpeg', 1.0),
                    'JPEG',
                    x,
                    y,
                    imgWidth,
                    imgHeight,
                    undefined,
                    'FAST'
                );

                // 保存 PDF
                pdf.save(filename);

                // 清理临时元素
                document.body.removeChild(tempContainer);

            } catch (error) {
                console.error('PDF generation error:', error);
                alert(`生成PDF时发生错误: ${error.message}`);
            } finally {
                // 移除加载提示
                document.body.removeChild(loadingDiv);
            }
        });
    </script>
</body>
</html>
